<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
     <title>Demographics</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" /> 
    <link rel="stylesheet" href="css/population_maps_style.css" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
    <link rel="stylesheet" href="css/perfect-scrollbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="shortcut icon" href="img/pnw.ico" type="image/x-icon">
    
     <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="js/Chart.bundle.js"></script>
    <script src="js/Chart.PieceLabel.min.js"></script>
    <script type="text/javascript" src="../js/clickFunction.js"></script>
    <script src="js/perfect-scrollbar.js"></script>
   
</head>
<body>
		<button id="collapse" onclick="collapse()">
			<i class="fa fa-chevron-left" id ="collapse-arrow" aria-hidden="true"></i>
		</button>
		<div id="infoPanel" style="background-color: rgba(255,255,255,1);">
			<div id="top">
				<h1 style="font-size:40px;">Demographics</h1>
				<img src="img/migration_icon.png" id="titleImage" style="display:inline-block;">
				<div id="buttons">
					<div class="dropdown">
						<button class="dropbtn"><b id="dataType">Select Data</b><p id="arrow">&#9660;</p></button>
						<div class="dropdown-content">
							 <button type="button" id="but1" class="selection" style="background:rgba(242, 242, 242, 0.8);">Race</button>
							 <button type="button" id="but2" class="selection">Age</button>
					   </div>
					</div>
				</div>
			</div>
			<div id="attribution">
				<div id="text">
					<div id='leg_1' style="display:unset;">
						<p id="description" style="font-weight:bold; margin-top: 10px;text-align:justify; white-space:normal; padding-left:0px; width:280px; display:block; position:relative;">Map colored based on a composite of racial population percentages. More intense colors suggest a greater percentage of a single race, while browns and grays suggest racial diversity.</p>
					</div>
					<div id='leg_2' style="display:none;">
						<h2 id="title" style="display:block; width:280px; white-space:normal;">Median Age</h2>
						<b id="leg2_block" style="background:linear-gradient(to right, #fcfbfd, #dadaeb, #9e9ac8, #6a51a3, #3f007d); height:32px; border:black 2px solid; width: 280px;"></b><br/>
						<p style="padding-left:0; word-spacing:40px;">25 35 45 55 65</p></br>
					</div>
					<br/>
					<h2 style="margin-top:0;">Hover Over Map for Details</h2>
					<canvas id="chartContainer" style="height: 160px ; width: 280px; display:unset; margin-left:-10px;"></canvas>
					<canvas id="chartContainer2" style="height: 260px ; width: 280px; display:none;"></canvas>
					<p id="description2" style="font-weight:bold; margin-top: 10px;text-align:justify; white-space:normal; padding-left:0px; width:280px; display:block; position:relative;">Population of each racial group within one census block group.</p>
				</div>
				<div id="pageChange">
					<a href="water_use_index.html" id="arrow" style="display:inline-block;">
						<i class="fa fa-arrow-left" aria-hidden="true" style=""></i>
					</a>
					<a href="#popup1" id="arrow" style="display:inline-block;">
						<i class="fa fa-info-circle" aria-hidden="true" style="padding-left:83px;"></i>
					</a>
					<a href="population_index.html" id="arrow" style="display:inline-block;">
						<i class="fa fa-home" aria-hidden="true" style="padding-left:0;"></i>
					</a>
					<a href="watershed_index.html" id="arrow" style="display:inline-block;">
						<i class="fa fa-arrow-right" aria-hidden="true" style="padding-left:82px;"></i>
					</a>
				</div>
			</div>
		</div>
    	<div id="map" style="width: 100%; height: 100%;"></div>
    	
    	<div id="popup1" class="overlay">
			<div class="popup">
				<h2 style="display:inline; font-size:32px;">Sources</h2>
				<a class="close" href="#" style="display:inline;">Ã—</a>
				<hr>
				<div class="content">
					<p2 style="font-size:20px">Geographic Data</p2><br><br/>
                    <div class="source">
                    	<b><p2>Census Block Groups: <a href = "https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_15_5YR_S1501&prodType=table" target="_blank">IPUMS: National Historical Geographic Information System</a></p2></b><br>
                    		<p3>Notes: IPUMS Data selected from ACS 2011-2015. Geographic Level: Census Block Group GIS Data.</p3>
                    </div>
                    <div class="source">
                    	<b><p2>Demographic Data: <a href = "https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_15_5YR_S1501&prodType=table" target="_blank">IPUMS: National Historical Geographic Information System</a></p2></b><br>
                    		<p3>Notes: IPUMS Data selected from ACS 2011-2015. Geographic Level: Census Block Group. Datasets: Sex by Age, Median Sex by Age, Hispanic or Latino Origin by Race.</p3>
                    </div>
				</div>
				<hr>
				<p2 style="float:right; font-size:12px;">Map created with Leaflet.</p2>
				<br/>
				<a class="close2" href="#" style="display:inline;">Close</a>
			</div>
		</div>
<script>
//////////////base functions (these never change)///////////////////////
	//////////////function for the info panel collapse button///////////////////////
	var collapsed = false;
    function collapse(){
    	if (collapsed == false){
    		document.getElementById("infoPanel").style.transition = "display 2s";
    		document.getElementById("infoPanel").style.display = "none";
    		document.getElementById("collapse").style.left = '0px';
    		document.getElementById("collapse").style.paddingLeft = '2px';
    		document.getElementById("collapse-arrow").className = "fa fa-chevron-right";
    		collapsed = true;
    	} else{
    		document.getElementById("infoPanel").style.display = "unset";
    		document.getElementById("collapse").style.left = '320px';
    		document.getElementById("collapse").style.paddingLeft = '0px';
    		document.getElementById("collapse-arrow").className = "fa fa-chevron-left";
    		collapsed = false;
    	}
    	
    }
	//////////////function that allows topojson layers to be loaded///////////////////////    
    L.TopoJSON = L.GeoJSON.extend({  
  		addData: function(jsonData) {    
    		if (jsonData.type === 'Topology') {
      			for (key in jsonData.objects) {
       			 geojson = topojson.feature(jsonData, jsonData.objects[key]);
       			 L.GeoJSON.prototype.addData.call(this, geojson);
      		}
    	}    
    	else {
      		L.GeoJSON.prototype.addData.call(this, jsonData);
    		}
  		}  
	});
//////////////Initialize map///////////////////////
	var map = L.map('map', {center: [45.56, -119.75], zoom: 7, zoomControl:false});
///////////////////////make zoom level correspond to browser size////////////////////////////////
	window.addEventListener('load', function(event){
    	var width = document.documentElement.clientWidth;
    	if (width < 1500 && width > 800) {
        	map.setView(new L.LatLng(45.56, -121.75), 6); 
    		}  else if (width > 1501) {
        	map.setZoom(7);
        	} else {
        	map.setZoom(5);
        	}
	});
////////////////////////////////basemap layers////////////////////////////////    
	var Esri_WorldTerrain = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: USGS, Esri, TANA, DeLorme, and NPS',
		maxZoom:10,
		minZoom:4,
		opacity:1
	}).addTo(map);
	
	var pnwCover = L.tileLayer.wms('http://mapious.ceoas.oregonstate.edu/geoserver/baldricg_PNW_ATLAS/wms', {
		layers: 'baldricg_PNW_ATLAS:pnw_outline2_black',
        format: 'image/png',
		maxZoom:10,
		minZoom:4,
		opacity:0.9,
		transparent:true,
	}).addTo(map);
	
	var label = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_only_labels/{z}/{x}/{y}@2x.png', {
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
		subdomains: 'abcd',
		maxZoom:10,
		minZoom:4,
		tileSize:256,
		bounds:[
			new L.LatLng(49.56,-125.25),
			new L.LatLng(40.5,-111.5)
		],
		pane:'labels'
	});	
	
	var pnwStates = $.getJSON("assets/pnw_states.geojson", function(data){
        pnwStates = L.geoJson(data, {
        	style:function pnwStatesStyle(){
				return{
					opacity: 1,
					color:'#ffffff',
					fillOpacity:0,
					weight:1
				};
			},
        	interactive: false
        }).addTo(map);
    });
    
    var pnwCounties = $.getJSON("assets/counties2.geojson", function(data){
        pnwCounties = L.geoJson(data, {
        	style: function pnwCountiesStyle(){
				return{
					opacity: 0.5,
					fillOpacity:0,
					color:'#ffffff',
					weight:0.25
				};
			},
			interactive: false
        }).addTo(map);
    });
    
	map.createPane('labels');
	map.getPane('labels').style.pointerEvents = 'none';
	map.getPane('labels').style.zIndex = 700;
	label.addTo(map);
	
	map.createPane('tooltip');
	map.getPane('tooltip').style.zIndex = 750;
////////////////////////////////important variables////////////////////////////////		
	var data = 1;
////////////////////////////display layers//////////////////////
    ////////////////////////////demographics topoJson for chart display//////////////////////
    const demographics = new L.TopoJSON();

	$.getJSON('assets/block_group_demographics.json')
  		.done(addTopoData);

	function addTopoData(topoData) {  
  		demographics.addData(topoData);
  		demographics.addTo(map);
  		demographics.eachLayer(handleLayer);
	}

	function handleLayer(layer){
        layer.setStyle({
          		opacity:0,
				color:'#ffffff',
				fillOpacity: 0,
				fillColor:'#f2f2f2',
				weight:0.5
        });
        layer.on({
         	mouseover : highlight,
            mouseout: resetHighlight
        });
    }
    
	function highlight(){
		 this.setStyle({
        	fillOpacity: 0.25,
        	opacity:1
    	 });
    	 if (data == 1){
    	 	chart.data.datasets[0].data[0] = this.feature.properties.white;
		 	chart.data.datasets[0].data[1] = this.feature.properties.black;
		 	chart.data.datasets[0].data[2] = this.feature.properties.asian;
		 	chart.data.datasets[0].data[3] = this.feature.properties.hisp_latin;
		 	chart.data.datasets[0].data[4] = this.feature.properties.ind_island;
			chart.data.datasets[0].data[5] = this.feature.properties.other_two;
		 	chart.update();
    	 }
    	 else{
			document.getElementById('title').innerHTML = "Median Age: " + this.feature.properties.med_age;
			chart2.data.datasets[0].data[17] = this.feature.properties.aunder5;
		 	chart2.data.datasets[0].data[16] = this.feature.properties.a5_9;
		 	chart2.data.datasets[0].data[15] = this.feature.properties.a10_14;
		 	chart2.data.datasets[0].data[14] = this.feature.properties.a15_19;
		 	chart2.data.datasets[0].data[13] = this.feature.properties.a20_24;
			chart2.data.datasets[0].data[12] = this.feature.properties.a25_29;
			chart2.data.datasets[0].data[11] = this.feature.properties.a30_34;
		 	chart2.data.datasets[0].data[10] = this.feature.properties.a35_39;
		 	chart2.data.datasets[0].data[9] = this.feature.properties.a40_44;
		 	chart2.data.datasets[0].data[8] = this.feature.properties.a45_49;
		 	chart2.data.datasets[0].data[7] = this.feature.properties.a50_54;
			chart2.data.datasets[0].data[6] = this.feature.properties.a55_59;
			chart2.data.datasets[0].data[5] = this.feature.properties.a60_64;
		 	chart2.data.datasets[0].data[4] = this.feature.properties.a65_69;
		 	chart2.data.datasets[0].data[3] = this.feature.properties.a70_74;
		 	chart2.data.datasets[0].data[2] = this.feature.properties.a75_79;
		 	chart2.data.datasets[0].data[1] = this.feature.properties.a80_84;
			chart2.data.datasets[0].data[0] = this.feature.properties.a85over;
		 	chart2.update();
    	 }
    }
    
    function resetHighlight(){
    	this.setStyle({
        	fillOpacity: 0,
        	opacity:0
    	 });
    }
  	////////////////////////////race chart//////////////////////
    var ctx = document.getElementById("chartContainer").getContext('2d');
	
	var options =  {
    	type: 'pie',
    		data: {
        		labels: ["White","Black","Asian","Latino/Hisp.","Indigenous","Other"],
        		datasets: [{
            		data: [50,50,50,50,50,50],
           			backgroundColor: [
                		'#80b1d3',
                		'#9fdf9f',
                		'#bebada',
                		'#fb8072',
                		'#ffffb3',
                		'#fdb462'
            		],
            		borderColor: [
                		'#404040',
                		'#404040',
                		'#404040',
                		'#404040',
                		'#404040',
                		'#404040'
            		],
            	borderWidth: 0
        	}]
    	},
    	options: {
       		responsive: true,
       		legend: {
       			position: 'left',
       			labels: {
       				fontColor:'#000000'
       			}
       		},
       		pieceLabel: {
    			render: 'value',
    			fontColor:'#000000'
  			},
       		tooltips:{
       			enabled:false
       		}
    	}
	}
	
	var chart = new Chart(ctx, options);
	////////////////////////////age chart//////////////////////	
	var ctx2 = document.getElementById("chartContainer2").getContext('2d');
	
	var ageOptions =  {
    	type: 'horizontalBar',
    		data: {
        		labels: ["85+","80-84","75-79","70-74","65-69","60-64","55-59","50-54","45-49","40-44","35-39","30-34","25-29","20-24","14-19","10-14","5-9","Under 5"],
        		datasets: [{
            		data: [50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50,50],
           			backgroundColor: [
                		'#261a32',
                		'#332343',
                		'#402c54',
                		'#4d3564',
                		'#593e75',
                		'#664686',
                		'#734f96',
                		'#8058a7',
                		'#8c69b0',
                		'#9979b9',
                		'#a68ac1',
                		'#b39bca',
                		'#bfabd3',
                		'#ccbcdc',
                		'#d9cde5',
                		'#e6deed',
                		'#f2eef6',
                		'#fcfbfd'
            		],
            		borderColor: [
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a',
                		'#1a1a1a'
            		],
            	borderWidth: 0.25
        	}]
    	},
    	options: {
       		responsive: true,
       		scales: {
       			yAxes: [{
       				ticks: {
       					fontSize:10
       				}
       			}]
       		},
       		legend: {
       			display:false,
       		},
       		tooltips:{
       			enabled:false
       		}
    	}
	}
	var chart2 = new Chart(ctx2, ageOptions);
	////////////////////////////race tilelayer//////////////////////
	var pnwDemographics = L.tileLayer.wms('http://mapious.ceoas.oregonstate.edu/geoserver/baldricg_PNW_ATLAS/wms', {
		layers: 'baldricg_PNW_ATLAS:pnw_demographics',
        format: 'image/png',
		maxZoom:10,
		minZoom:4,
		opacity:0.7,
		transparent:true,
	}).addTo(map);
	////////////////////////////age tilelayer//////////////////////
	var pnwAge = L.tileLayer('med_age_tiles/{z}/{x}/{y}.png', {
        maxZoom:10,
		minZoom:4,
		opacity:0.7,
        tms: false,
        transparent:true,
      });
///////////////////////////////button function////////////////////////////////		
	var buttonLabels = ['#but1','#but2'];

	var buttonFunctions = {
		but1: {button:'but1', newLayers:[pnwDemographics], newLegend: 'leg_1', title:'Race', newElements:['chartContainer'], variable:1, layerFunction:function(){document.getElementById('description2').innerHTML = "Population of each racial group within one census block group.";}},
		but2: {button:'but2', newLayers:[pnwAge], newLegend: 'leg_2', title:'Age', newElements:['chartContainer2'], variable:2, layerFunction:function(){document.getElementById('description2').innerHTML = "Population of each age group within a census block group.";}}
	};
	
	$('.main').clickFunction({
		buttonFunctions: buttonFunctions,
		buttonLabels: buttonLabels,
		selected:buttonFunctions.but1
	});
	
///////////////////////////////other miscellaneous functions (these also never change)////////////////////////////////   

   	//add zoom control
    new L.Control.Zoom({ position: 'topright' }).addTo(map);
    
    //remove leaflet attribution
	document.getElementsByClassName("leaflet-control-attribution")[0].style.visibility = "hidden";
	
	//add scrolling capabilities to text box
     var container = document.getElementById('text');
		Ps.initialize(container);
	
	//update text box to be correct size
	var minHeight = 50; // Define a minimum height for the middle div

	function resizeMiddle() {
    var h = $('body').height() - $('#top').height() - 95;
    		h = h > minHeight ? h : minHeight;
   	 	$('#attribution').height(h);
	}

	$(document).ready(resizeMiddle);
	$(window).resize(resizeMiddle);
	
    //remove standard leaflet attribution
    

</script>
</body>
</html>
