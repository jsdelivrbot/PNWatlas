<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
     <title>Disaster Risk</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" /> 
    <link rel="stylesheet" href="css/hazard_map_style.css" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
    <link rel="stylesheet" href="css/perfect-scrollbar.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <link rel="shortcut icon" href="img/pnw.ico" type="image/x-icon">
    
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="js/Chart.bundle.js"></script>
    <script src="js/Chart.PieceLabel.min.js"></script>
    <script src="js/perfect-scrollbar.js"></script>
    <script type="text/javascript" src="../js/clickFunction.js"></script>    
   
</head>
<body>
		<!--This is the button that collapses the info panel-->
		<button id="collapse" onclick="collapse()">
			<i class="fa fa-chevron-left" id ="collapse-arrow" aria-hidden="true"></i>
		</button>
		<!--Info panel on the left side of the screen. Dataset selection, legends, and additional information about the map is presented here.-->
		<div id="infoPanel">
			<!--Upper half of the info panel. This part of the info panel will always remain the same size. This usually includes the data selection and the main legend. Try not to make this too tall, or it will be cut off on smaller screens.-->
			<div id="top"> 
				<h1 style="font-size:38px;">Vulnerability & Risk</h1><!--Map title-->
				<img src="img/vulnerability_icon.png" id="titleImageCircle" > <br/><!--Banner image-->
				<!--Dropdown menu for dataset selection-->
				<div id="buttons">
					<div class="dropdown">
						<button class="dropbtn"><b id="dataType">Select Dataset</b><p id="arrow">&#9660;</p></button>
							<div class="dropdown-content">
								<button type="button" id="but1" style="background:rgba(242, 242, 242, 0.67);" class="selection">Risk</button>
								<button type="button" id="but2" class="selection">Declarations</button>
							</div>
					</div>
				</div>
			</div>
			<div id="attribution">
				<div id="text">
				<!--Legends for each dataset-->	
					<div id="leg_1" style="display:unset;">
						<h2 id="title" >Natural Hazard Risk Index</h2><img src="img/disaster_icon.png" id="iconImage" style="right:20px;">
						<div style="height:32px;"><b id="leg1_block" style="background:#b30000; border-left:black 2px solid; border-right:black 2px solid; border-top:black 2px solid;"></b><p style="margin-left:5px;">16+</p></div>
						<div style="height:30px;"><b id="leg2_block" style="background:#e34a33; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">14 - 16</p></div>
						<div style="height:30px;"><b id="leg3_block" style="background:#fc8d59; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">12 - 14</p></div>
						<div style="height:30px;"><b id="leg4_block" style="background:#fdcc8a; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">10 - 12</p></div>
						<div style="height:32px;"><b id="leg5_block" style="background:#fef0d9; border-left:black 2px solid; border-right:black 2px solid; border-bottom:black 2px solid;"></b><p style="margin-left:5px;">Under 10</p></div>
						<br/>
						<p id="description" style="font-weight:bold; text-align:justify; white-space:normal; padding-left:0px; width:280px; display:block; position:relative;">The Natural Hazard Risk Index is a compilation of various natural hazard risk factors. Higher index values indicate higher risk for multiple disaster types.</p>
					</div>			
					<div id="leg_2" style="display:none;">
						<h2 id="title" style="margin-bottom:0px;">Disaster Declarations</h2>
						<p2 style="display:block; width:280px; white-space:normal; font-style:italic; margin-bottom:5px;">Number of declared disasters since 1953</p2><img src="img/disaster_icon.png" id="iconImage" style="right:20px;">
						<div style="height:32px;"><b id="leg1_block" style="background:#b30000; border-left:black 2px solid; border-right:black 2px solid; border-top:black 2px solid;"></b><p style="margin-left:5px;">20+</p></div>
						<div style="height:30px;"><b id="leg2_block" style="background:#e34a33; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">15 - 20</p></div>
						<div style="height:30px;"><b id="leg3_block" style="background:#fc8d59; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">10 -15</p></div>
						<div style="height:30px;"><b id="leg4_block" style="background:#fdcc8a; border-left:black 2px solid; border-right:black 2px solid;"></b><p style="margin-left:5px;">5 - 10</p></div>
						<div style="height:32px;"><b id="leg5_block" style="background:#fef0d9; border-left:black 2px solid; border-right:black 2px solid; border-bottom:black 2px solid;"></b><p style="margin-left:5px;">Less than 5</p></div>
						<br/>
						<p id="description" style="font-weight:bold; text-align:justify; white-space:normal; padding-left:0px; width:280px; display:block; position:relative;">Federally declared disasters since 1953.</p>
					</div>	
				</div>
			<!--Bottom part of the info panel. This part of the info panel includes arrows to shift between maps, the info button that contains the map sources, and the home button to return to the chapter title screen.-->
				<div id="pageChange">
					<a href="#popup1" id="arrow" style="display:inline-block;">
						<i class="fa fa-info-circle" aria-hidden="true" style="padding-left:105px;"></i>
					</a>
					<a href="#popup2" id="arrow" style="display:inline-block;">
						<i class="fa fa-home" aria-hidden="true" style="padding-left:0;"></i>
					</a>
				</div>
			</div>
		</div>
    	<div id="map" style="width: 100%; height: 100%;"></div>
    	
    	<!--Map sources popup-->
    	<div id="popup1" class="overlay">
			<div class="popup">
				<h2 style="display:inline; font-size:32px;">Sources</h2>
				<a class="close" href="#" style="display:inline;">×</a>
				<hr>
				<div class="content">
					<p2 style="font-size:20px">Geographic Data</p2><br><br/>
                    <div class="source">
                		<b><p2>US Natural Hazards Index: <a href = "http://ncdp.columbia.edu/library/mapsmapping-projects/us-natural-hazards-index/" target="_blank">National Center for Disaster Preparedness</a></p2></b><br>
                	</div>
                    <div class="source">
                    	<b><p2>Disaster Declarations: <a href = "https://www.fema.gov/data-visualization-disaster-declarations-states-and-counties" target="_blank">FEMA</a></p2></b><br>
                    </div>
				</div>
				<hr>
				<p2 style="float:right; font-size:12px;">Map created with Leaflet.</p2>
				<br/>
				<a class="close2" href="#" style="display:inline;">Close</a>
			</div>
		</div>
		
		<div id="popup2" class="overlay2">
			<div class="popup2">
				<a class="close" href="#" style="display:inline;">×</a>
				<div class="content">
					<a href="hazard_index.html" style="font-weight:bold; text-decoration:none;">Hazards Home</a>
					<hr>
					<a href="vulnerability_index.html" style="text-decoration:underline;">Disaster Risk</a>
					<a href="earthquake_index.html" style="text-decoration:underline;">Earthquakes</a>
					<a href="flood_index.html" style="text-decoration:underline;">Flooding</a>
					<a href="volcano_index.html" style="text-decoration:underline;">Volcanos</a>
					<a href="drought_index.html" style="text-decoration:underline;">Drought</a>
					<a href="weather_index.html" style="text-decoration:underline;">Extreme Weather</a>
					<a href="wildfire_index.html" style="text-decoration:underline;">Wildfires</a>
					<hr>
					<a href="../index.html" style="font-weight:bold; text-decoration:none;">Atlas Home</a>
				</div>
			</div>
		</div>
<script>
//////////////base functions (these never change)///////////////////////
	var collapsed = false;
 	//////////////function for the info panel collapse button///////////////////////
    function collapse(){
    	if (collapsed == false){
    		document.getElementById("infoPanel").style.transition = "display 2s";
    		document.getElementById("infoPanel").style.display = "none";
    		document.getElementById("collapse").style.left = '0px';
    		document.getElementById("collapse").style.paddingLeft = '2px';
    		document.getElementById("collapse-arrow").className = "fa fa-chevron-right";
    		collapsed = true;
    	} else{
    		document.getElementById("infoPanel").style.display = "unset";
    		document.getElementById("collapse").style.left = '320px';
    		document.getElementById("collapse").style.paddingLeft = '0px';
    		document.getElementById("collapse-arrow").className = "fa fa-chevron-left";
    		collapsed = false;
    	}
    	
    }
	//////////////function that allows topojson layers to be loaded///////////////////////
    L.TopoJSON = L.GeoJSON.extend({  
  		addData: function(jsonData) {    
    		if (jsonData.type === 'Topology') {
      			for (key in jsonData.objects) {
       			 geojson = topojson.feature(jsonData, jsonData.objects[key]);
       			 L.GeoJSON.prototype.addData.call(this, geojson);
      		}
    	}    
    	else {
      		L.GeoJSON.prototype.addData.call(this, jsonData);
    		}
  		}  
	});
//////////////Initialize map///////////////////////
	var map = L.map('map', {center: [45.56, -119.75], zoom: 7, zoomControl:false});
///////////////////////make zoom level correspond to browser size////////////////////////////////
	window.addEventListener('load', function(event){
    	var width = document.documentElement.clientWidth;
    	if (width < 1500 && width > 800) {
        	map.setView(new L.LatLng(45.56, -121.75), 6); 
    		}  else if (width > 1501) {
        	map.setZoom(7);
        	} else {
        	map.setZoom(5);
        	}
	});
////////////////////////////////basemap layers////////////////////////////////
	var Esri_WorldTerrain = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: USGS, Esri, TANA, DeLorme, and NPS',
		maxZoom:10,
		minZoom:5,
		opacity:1
	}).addTo(map);

	var pnwCover = L.tileLayer.wms('http://mapious.ceoas.oregonstate.edu/geoserver/baldricg_PNW_ATLAS/wms', {
		layers: 'baldricg_PNW_ATLAS:pnw_outline2_black',
        format: 'image/png',
		maxZoom:10,
		minZoom:5,
		opacity:0.3,
		transparent:true,
	}).addTo(map);

	
	var label = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_only_labels/{z}/{x}/{y}@2x.png', {
		attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
		subdomains: 'abcd',
		maxZoom:10,
		minZoom:5,
		tileSize:256,
		bounds:[
			new L.LatLng(49.56,-125.25),
			new L.LatLng(40.5,-111.5)
		],
		pane:'labels'
	});	
	
	var pnwCounties;
    pnwCounties = L.geoJson(null, {
        	style: function pnwCountiesStyle(){
				return{
					pane:'labels',
					opacity: 0.5,
					fillOpacity:0,
					color:'#4d4d4d',
					weight:0.25
				};
			},
			interactive: false
        });
    
    $.getJSON("assets/pnw_counties.geojson", function(data) {
        pnwCounties.addData(data);
    });

	//labels pane allows
	map.createPane('labels');
	map.getPane('labels').style.pointerEvents = 'none';
	map.getPane('labels').style.zIndex = 600;
	label.addTo(map);

////////////////////////////////important variables////////////////////////////////
	var data = 1; //this variable is the listener for whenever a new dataset is selected
	
////////////////////////////////info control in upper right////////////////////////////////
	var info = L.control();

	info.onAdd = function (map) {
    	this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    	this.update();
    	return this._div;
	};
	
	info.update = function () {
   		this._div.innerHTML = (
        	'<h2>Hover over map</h2>');
		};

	info.addTo(map);
////////////////////////////display layers//////////////////////
	////////////////////////////////dataset 1////////////////////////////////
  	/*var svi = new L.TopoJSON(null, {
  		onEachFeature: function(feature, featureLayer){
  			featureLayer.bindTooltip('<h3 style="margin: 0px 0px;">' + feature.properties.COUNTY + '</h3><p style="margin:0; font-size:16px;">Percentile: ' + feature.properties.PER2 + '</p>', {className: 'label_tooltip'});
  			featureLayer.bindPopup('<h3 style="margin: 0px 0px;">' + feature.properties.COUNTY + '</h3><p style="margin:0; font-size:16px;">Percentile: ' + feature.properties.PER2 + '</p>', {className: 'label_tooltip'});
  			}
		});

	$.getJSON('assets/SVI.json')
  		.done(sviAddTopoData);

	function sviAddTopoData(topoData) {  
  		svi.addData(topoData);
  		//svi.addTo(map);
  		svi.eachLayer(sviHandleLayer);
	}
	
	function sviColor(value){
        return value > 80 ? '#ca0020' :
            value > 60 ? '#f4a582' :
            value > 40 ? '#f2f2f2' :
            value >  20 ? '#92c5de' :
                '#0571b0';    	
    	}
	
	function sviHandleLayer(layer){
        layer.setStyle({
       			fillColor: sviColor(layer.feature.properties.PER2),
            	fillOpacity: 0.6,
            	weight: 1,
            	opacity: 0.3,
            	color: sviColor(layer.feature.properties.PER2)
        });
        layer.on({
         	mouseover : sviHighlight,
            mouseout: sviResetHighlight
        });
    }
    
    function sviHighlight(){
      this.bringToFront();
      this.setStyle({
        	fillOpacity: 1,
        	color:'#000000',
        	dashArray: 4,
        	weight: 1.5
      });
      //info.update(this.feature.properties);
    }
    
    function sviResetHighlight(){
      this.setStyle({
        	fillOpacity: 0.6,
        	dashArray: null,
        	color: sviColor(this.feature.properties.PER2),
        	weight:1
      });
      //info.update();
    }*/
    
    ////////////////////////////////dataset 2 ////////////////////////////////  	
    var disasterCounties = null;
    disasterCounties = new L.TopoJSON(null, {
  		onEachFeature: function(feature, featureLayer){
  			featureLayer.bindTooltip('<h3 style="margin: 0px 0px;">' + feature.properties.NAME + '</h3><div id="list" style="font-size: 16px;">' + tooltip(feature.properties) +'</div>', {className: 'label_tooltip'});
  			featureLayer.bindPopup('<h3 style="margin: 0px 0px;">' + feature.properties.NAME + '</h3><div id="list" style="font-size: 16px;">' + tooltip(feature.properties) +'</div>', {className: 'label_tooltip'});
  			}
		});
	
	//function for displaying disasters in tooltip	
    function tooltip(props){
   	 	var disasters = [props.flood, props.fishing, props.fire, props.drought, props.sev_strm, props.cast_strm, props.hurricane, props.snow, props.landslide, props.tsunami, props.volcano, props.earthquake];
    	var disasterLabel = ["Floods: ", "Fishing Damages: ", "Fires: ", "Drought: ", "Severe Storms: ", "Coastal Storms: ", "Hurricanes: ", "Snow: ", "Landslides: ", "Tsunami: ", "Volcano: ", "Earthquake: "];
   	 	var exit;
   	 	for (i = 0; i < disasters.length; i++){
      		if (disasters[i] > 0){
      			if (exit){
      	  			exit = exit + disasterLabel[i] + disasters[i] + '</br>';
      	  		}
      	  		else{
      	  			exit = disasterLabel[i] + disasters[i] + '</br>';
      	  		}
      	 	}	
    	}
    	return exit;
	}
	
	$.getJSON('assets/disaster_counties.json')
  		.done(disasterCountiesAddTopoData);

	function disasterCountiesAddTopoData(topoData) {  
  		disasterCounties.addData(topoData);
  		disasterCounties.eachLayer(disasterCountiesHandleLayer);
	}
	
	function disasterCountiesColor(value){
        return value > 20 ? '#b30000' :
            value > 15 ? '#e34a33' :
            value > 10 ? '#fc8d59' :
            value > 5 ? '#fdcc8a' :
                '#fef0d9';
    	}
	
	function disasterCountiesHandleLayer(layer){
        layer.setStyle({
        		fillColor: disasterCountiesColor(layer.feature.properties.total),
            	fillOpacity: 0.7,
            	weight: 1.5,
            	opacity: 0.5,
            	color: '#ffffff',
        });
        layer.on({
         	mouseover : disasterCountiesHighlight,
            mouseout: resetDisasterCountiesHighlight
        });
    }
    
    function disasterCountiesHighlight(){
      this.bringToFront();
      this.setStyle({
        	fillOpacity: 1,
        	color:'#000000',
        	dashArray: 4
      });

      //info.update(this.feature.properties);
    }
    
    function resetDisasterCountiesHighlight(){
      this.setStyle({
        	fillOpacity: 0.7,
        	dashArray: null,
        	color: '#ffffff'
      });
      //info.update();
    }
    ////////////////////////////////county risk////////////////////////////////  	
    var riskCounties = null;
    riskCounties = new L.TopoJSON(null, {
  		onEachFeature: function(feature, featureLayer){
  			featureLayer.bindTooltip('<h3 style="margin: 0px 0px;">' + feature.properties.NAME + '</h3><div id="list" style="font-size: 16px;">Risk Index: ' + feature.properties.risk_index + '</br>' + tooltipRisk(feature.properties) +'</div>', {className: 'label_tooltip'});
  			featureLayer.bindPopup('<h3 style="margin: 0px 0px;">' + feature.properties.NAME + '</h3><div id="list" style="font-size: 16px;">Risk Index: ' + feature.properties.risk_index + '</br>' + tooltipRisk(feature.properties) +'</div>', {className: 'label_tooltip'});
  			}
		});
	
	//function for displaying disasters in tooltip	
    function tooltipRisk(props){
   	 	var disasters = [props.wildfire, props.volcano, props.tornado, props.snowfall, props.landslide, props.hurricane, props.earthquake, props.drought, props.heatwave, props.avalanche, props.flood];
    	var disasterLabel = ["Wildfire: ", "Volcano: ", "Tornado: ", "Snowfall: ", "Landslide: ", "Hurricane: ", "Earthquake: ", "Drought: ", "Heatwave: ", "Avalanche: ", "Flood: "];
   	 	var exit;
   	 	for (i = 0; i < disasters.length; i++){
      		if (disasters[i] != 'None'){
      			if (exit){
      	  			exit = exit + disasterLabel[i] + disasters[i] + '</br>';
      	  		}
      	  		else{
      	  			exit = disasterLabel[i] + disasters[i] + '</br>';
      	  		}
      	 	}	
    	}
    	return exit;
	}
	
	$.getJSON('assets/risk_counties.json')
  		.done(riskCountiesAddTopoData);

	function riskCountiesAddTopoData(topoData) {  
  		riskCounties.addData(topoData);
  		riskCounties.addTo(map);
  		riskCounties.eachLayer(riskCountiesHandleLayer);
	}
	
	function riskCountiesColor(value){
        return value > 16 ? '#b30000' :
            value > 14 ? '#e34a33' :
            value > 12 ? '#fc8d59' :
            value > 10 ? '#fdcc8a' :
                '#fef0d9';
    	}
	
	function riskCountiesHandleLayer(layer){
        layer.setStyle({
        		fillColor: riskCountiesColor(layer.feature.properties.risk_index),
            	fillOpacity: 0.7,
            	weight: 1.5,
            	opacity: 0.5,
            	color: '#ffffff',
        });
        layer.on({
         	mouseover : disasterCountiesHighlight,
            mouseout: resetDisasterCountiesHighlight
        });
    }
///////////////////////////////button function////////////////////////////////
	//this function uses the ClickFunction plugin to easily add/remove layers, change legends, styling and anything else when a new dataset is selected from the dropdown buttons  		
	var buttonLabels = ['#but1','#but2','#but3'];//add button IDs here

	var buttonFunctions = {
		but1: {button:'but1',//button ID 
				newLayers:[riskCounties], //layers to add
				newLegend: 'leg_1', //legend div ID
				title:'Hazard Risk', //title to display in dropdown menu
				variable:1 //update the 'data' variable
			},
		but2: {button:'but2', 
			newLayers:[disasterCounties], 
			newLegend: 'leg_2', 
			title:'Declared Disasters', 
			variable:2,
		}

	};
	
	$('.function').clickFunction({
		buttonFunctions: buttonFunctions,
		buttonLabels: buttonLabels,
		selected:buttonFunctions.but1 //choose which button is initially selected
	});
	
 ///////////////////////////////other miscellaneous functions (these also never change)////////////////////////////////   
   	//add zoom control
    new L.Control.Zoom({ position: 'topright' }).addTo(map);
    
    //remove leaflet attribution
	document.getElementsByClassName("leaflet-control-attribution")[0].style.visibility = "hidden";
	
	//add scrolling capabilities to text box
     var container = document.getElementById('text');
		Ps.initialize(container);
	
	//update text box to be correct size
	var minHeight = 50; // Define a minimum height for the middle div

	function resizeMiddle() {
   		var h = $('body').height() - $('#top').height() - 95;
    		h = h > minHeight ? h : minHeight;
   	 	$('#attribution').height(h);
	}
	
	function resizePopup() {
   		var h = $('.popup').height() - 90;
    		h = h > minHeight ? h : minHeight;
   	 	$('.popup .content').height(h);
	}
	$(document).ready(resizePopup);
	$(window).resize(resizePopup);

	$(document).ready(resizeMiddle);
	$(window).resize(resizeMiddle);    

</script>
</body>
</html>
